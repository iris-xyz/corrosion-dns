# Test image for loopback integration tests.
# Requires --privileged to add IPv6 addresses to lo.
#
# Usage:
#   docker build -f Dockerfile.test -t corrosion-dns-test .
#   docker run --rm --privileged corrosion-dns-test \
#     cargo test --test group_filter_loopback --features integration-loopback -- --test-threads=1

FROM rust:bookworm

RUN apt-get update && apt-get install -y iproute2 && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .

# Pre-compile test binary so the run step is fast.
RUN cargo test --no-run --test group_filter_loopback --features integration-loopback 2>&1 || true

CMD ["cargo", "test", "--test", "group_filter_loopback", "--features", "integration-loopback", "--", "--test-threads=1"]
